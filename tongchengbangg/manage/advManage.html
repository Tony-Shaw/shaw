<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
 
    <title>广告管理</title>
    <!-- <link rel="shortcut icon" href="#" /> -->
    <style>
        table{
            width: 100%;border-collapse: collapse;
        }
        table td{
            border: 1px solid green;
            text-align: center;

        }
    </style>

    <script src="js/baiduTemplate.js"></script>
</head>
<body>
    <div>
        <form name="myform">
                <input type="text" hidden name="id">
                <p>广告标题：<input type="text" name="advName"></p>
                <p>
                    广告图片：<input type="file"   onchange = "changeImg(this)"; name="advPic">
                    <img  height="200" id="myImg" src="" alt="">
        </p>
        
                <p>广告类别：<select name="advType">
                    <option value="1">轮播图</option>
                    <option value="2">轮播图底部</option>
                    <option value="3">热门手机回收</option>
                    <option value="4">优品精选</option>
                </select></p>
                <p>广告链接：<input type="text" name="advHref"></p>
                <p>广告排序：<input type="text" name="orderNum"></p>
                <p><input type="button" id="btn" value="提交"></p>
            </form>
            <hr>
            <div id="search">
                <input type="text" oninput="getAdv()" id="keyword">
                <input type="button" value="全部">
                <input type="button" value="轮播图">
                <input type="button" value="轮播图底部">
                <input type="button" value="热门手机回收">
                <input type="button" value="优品精选">
            </div>

            <hr>
            <div id="wrap">
            
            </div>
    </div>
  <script type="text/html" id="tp">
        <table>
            <tr>
                <td>id</td>
                <td>广告标题</td>
                <td>广告图片</td>
                <td>广告链接</td>
                <td>广告类型</td>
                <td>广告排序</td>
                <td>添加时间</td>
                <td>修改时间</td>
                <td>操作</td>

            </tr>
            <%for(let i=0;i<advList.length;i++){%>
                <tr>
                        <td><%=advList[i]._id%></td>
                        <td><%=advList[i].advName%></td>
                        <td><img height="100" src="<%=advList[i].advPic%>" alt=""></td>
                        <td><%=advList[i].advHref%></td>
                        <td><%=advTypeEnum[advList[i].advType]%></td>
                        <td><%=advList[i].orderNum%></td>
                        <td><%=advList[i].addTime%></td>
                        <td><%=advList[i].upTime%></td>
                        <td>
                              <a href="javascript:;" onclick="getAdvById('<%=advList[i]._id%>')">修改</a>
                              <a href="javascript:;" onclick="deleteAdv('<%=advList[i]._id%>',<%=pageIndex%>)">删除</a>


                        </td>
        
                    </tr>
            <%}%>
        </table>
        <div>
            <a href="javascript:;" onclick="getAdv(<%=pageIndex-1%>)">上一页</a>
            <%=pageIndex%>/<%=pageSum%>
            <a href="javascript:;" onclick="getAdv(<%=pageIndex+1%>)">下一页</a>
        </div>
  </script>
</body>
    <script>
        var btn = document.querySelector("#btn");
        const searchBtn = document.querySelectorAll("#search input[type='button']");
        let advType = 0;//下标 ，默认选中值
        const advTypeEnum = {
            "1":"轮播图",
            "2":"轮播图底部",
            "3":"热门手机回收",
            "4":"优品精选"
        }
        getAdv();
        // for(let i = 0 ; i < searchBtn.length;i++){ //为什么let改为var输出值会变成4
        //     searchBtn[i].onclick = function (){
        //         console.log(i);
        //     }
        // }
        // for(var i = 0 ; i < searchBtn.length;i++){ 
        //     searchBtn[i].index = i;
        //     searchBtn[i].onclick = function (){
        //         console.log(this.index);
        //     }
        // }
        searchBtn[advType].style.background = "red";
        for(var i = 0 ; i < searchBtn.length;i++){ 
           searchBtn[i].onclick = (function (i) {
               return function (){
                    searchBtn[advType].style.background = null;
                    advType = i;
                    searchBtn[advType].style.background = "red";
                    getAdv(1);
            }
           })(i);
        }
        btn.onclick = function () {
        var formdata = new FormData(document.myform);
        var xhr = new XMLHttpRequest();
        if(document.myform.id.value.length>0){// 修改
            //post:  json,urlencoded formdata
            xhr.open("put","/adv");
        }else{// 添加
            xhr.open("post","/adv");
        }
        xhr.send(formdata);
        xhr.onload = function (ev) {
            console.log(xhr.responseText);

            var data = JSON.parse(xhr.responseText);
            console.log(data)
            if(data.ok === 1){
                document.myform.reset();// 重置
                btn.value = "提交";
                getAdv();
            }
            else{
                alert(data.msg);
            }
        }

        
    };
        //realize preview
        function changeImg(_this){
            //将上传的文件转为base64
            const reader = new FileReader();
            reader.readAsDataURL(_this.files[0]);
            reader.onload = function(ev){
                // console.log(ev.target.result);
                document.querySelector("#myImg").src = ev.target.result;
            }
        }
        function getAdv(pageI = 1){
            var xhr = new XMLHttpRequest();
            xhr.open("get",'/adv?pageIndex='+pageI+"&advType="+advType+"&keyword="+document.querySelector("#search input[type=text]").value);
            xhr.send();
            xhr.onload = function(ev){
                const data = JSON.parse(xhr.responseText);
                document.querySelector("#wrap").innerHTML = baidu.template("tp",data);
            }
        }
        function deleteAdv(id,pageIndex) {
        var xhr = new XMLHttpRequest();
        xhr.open("delete","/adv/"+id);
        xhr.send();
        xhr.onload = function (ev) {
            var obj = JSON.parse(xhr.responseText);
            if(obj.ok === 1){
                getAdv(pageIndex)
            }else{
                alert(obj.msg);
            }
        }
    }
    //modify
    function getAdvById(id) {
        var xhr = new XMLHttpRequest();
        xhr.open("get","/adv/"+id);
        xhr.send();
        xhr.onload = function (ev) {
            const  {advInfo} = JSON.parse(xhr.responseText);
            document.myform.advName.value = advInfo.advName;
            document.myform.advType.value = advInfo.advType;
            document.myform.advHref.value = advInfo.advHref;
            document.myform.orderNum.value = advInfo.orderNum;
            document.myform.id.value = advInfo._id;
            document.querySelector("#myImg").src = advInfo.advPic;
            btn.value= "修改";
            // console.log(document.myform);
            // console.log(btn);
        }
    }
  </script>
</html>